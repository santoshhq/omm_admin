// api_service.dart
import 'dart:convert';
import 'dart:io';
import 'package:http/http.dart' as http;

class ApiService {
  // Dynamic base URL based on platform
  static String get baseUrl {
    if (Platform.isAndroid) {
      // For Android emulator, use 10.0.2.2 to access host machine
      return "http://10.0.2.2:8080/api/auth";
    } else if (Platform.isIOS) {
      // For iOS simulator, use localhost or your machine's IP
      return "http://localhost:8080/api/auth";
    } else {
      // For web/desktop development
      return "http://localhost:8080/api/auth";
    }
  }

  // Dynamic base URL for admin profiles based on platform
  static String get adminProfileBaseUrl {
    if (Platform.isAndroid) {
      // For Android emulator, use 10.0.2.2 to access host machine
      return "http://10.0.2.2:8080/api/admin-profiles";
    } else if (Platform.isIOS) {
      // For iOS simulator, use localhost or your machine's IP
      return "http://localhost:8080/api/admin-profiles";
    } else {
      // For web/desktop development
      return "http://localhost:8080/api/admin-profiles";
    }
  }

  // Dynamic base URL for admin members based on platform
  static String get adminMemberBaseUrl {
    if (Platform.isAndroid) {
      // For Android emulator, use 10.0.2.2 to access host machine
      return "http://10.0.2.2:8080/api/admin-members";
    } else if (Platform.isIOS) {
      // For iOS simulator, use localhost or your machine's IP
      return "http://localhost:8080/api/admin-members";
    } else {
      // For web/desktop development
      return "http://localhost:8080/api/admin-members";
    }
  }

  // Dynamic base URL for amenities based on platform
  static String get amenitiesBaseUrl {
    if (Platform.isAndroid) {
      // For Android emulator, use 10.0.2.2 to access host machine
      return "http://10.0.2.2:8080/api/amenities";
    } else if (Platform.isIOS) {
      // For iOS simulator, use localhost or your machine's IP
      return "http://localhost:8080/api/amenities";
    } else {
      // For web/desktop development
      return "http://localhost:8080/api/amenities";
    }
  }

  // Dynamic base URL for events based on platform
  static String get eventsBaseUrl {
    if (Platform.isAndroid) {
      // For Android emulator, use 10.0.2.2 to access host machine
      return "http://10.0.2.2:8080/api/events";
    } else if (Platform.isIOS) {
      // For iOS simulator, use localhost or your machine's IP
      return "http://localhost:8080/api/events";
    } else {
      // For web/desktop development
      return "http://localhost:8080/api/events";
    }
  }

  /// Signup
  static Future<Map<String, dynamic>> signup(
    String email,
    String password,
  ) async {
    try {
      print("üöÄ Starting signup process...");
      print("üìß Email: $email");
      print("üåê Platform: ${Platform.operatingSystem}");
      print("üîó Base URL: $baseUrl");
      print("ÔøΩ Full URL: $baseUrl/signup");

      final url = Uri.parse("$baseUrl/signup");
      final response = await http.post(
        url,
        headers: {"Content-Type": "application/json"},
        body: jsonEncode({"email": email, "password": password}),
      );

      print("üì± Response Status: ${response.statusCode}");
      print("üì± Response Body: ${response.body}");

      final body = jsonDecode(response.body);

      if (response.statusCode == 201 && body["status"] == true) {
        print("‚úÖ Signup successful!");
        // Convert backend response to frontend expected format
        return {
          "success": true,
          "message": body["message"],
          "email": email,
          "otp": body["data"]["otp"], // For development - OTP from backend
          "userId":
              body["data"]["userId"] ??
              body["data"]["id"], // User ID from backend
        };
      } else {
        print("‚ùå Signup failed: ${body["message"]}");
        throw Exception(body["message"] ?? "Signup failed");
      }
    } catch (e) {
      print("üî• Error in signup: $e");
      // Check if it's a network error (backend not running)
      if (e.toString().contains('SocketException') ||
          e.toString().contains('Connection refused') ||
          e.toString().contains('Failed host lookup')) {
        throw Exception(
          "‚ùå Cannot connect to server. Please ensure your backend server is running on http://localhost:8080",
        );
      }
      // Re-throw other errors
      throw Exception("Signup failed: $e");
    }
  }

  /// Login
  static Future<Map<String, dynamic>> login(
    String email,
    String password,
  ) async {
    try {
      final url = Uri.parse("$baseUrl/login");
      final response = await http.post(
        url,
        headers: {"Content-Type": "application/json"},
        body: jsonEncode({"email": email, "password": password}),
      );

      final body = jsonDecode(response.body);

      if (response.statusCode == 200 && body["status"] == true) {
        print("‚úÖ Login successful!");
        // Convert backend response to frontend expected format
        return {
          "success": true,
          "message": body["message"],
          "token":
              "auth_token_${body["data"]["id"]}", // Generate token based on user ID
          "user": {
            "email": body["data"]["email"],
            "id": body["data"]["id"],
            "isProfile":
                body["data"]["isProfile"] ??
                false, // Profile completion status from backend
          },
        };
      } else {
        print("‚ùå Login failed: ${body["message"]}");
        throw Exception(body["message"] ?? "Login failed");
      }
    } catch (e) {
      print("üî• Error in login: $e");
      // Check if it's a network error (backend not running)
      if (e.toString().contains('SocketException') ||
          e.toString().contains('Connection refused') ||
          e.toString().contains('Failed host lookup')) {
        throw Exception(
          "‚ùå Cannot connect to server. Please ensure your backend server is running on http://localhost:8080",
        );
      }
      // Re-throw other errors
      throw Exception("Login failed: $e");
    }
  }

  /// Verify OTP (for signup flow)
  static Future<bool> verifyOtp(String email, String otp) async {
    try {
      final url = Uri.parse("$baseUrl/verify-otp");
      final response = await http.post(
        url,
        headers: {"Content-Type": "application/json"},
        body: jsonEncode({"email": email, "otp": otp}),
      );

      print("üì± OTP Verify Response Status: ${response.statusCode}");
      print("üì± OTP Verify Response Body: ${response.body}");

      final body = jsonDecode(response.body);

      if (response.statusCode == 200 && body["status"] == true) {
        print("‚úÖ OTP verification successful!");
        return true;
      } else {
        print("‚ùå OTP verification failed: ${body["message"]}");
        return false;
      }
    } catch (e) {
      print("üî• Error in OTP verification: $e");
      // Check if it's a network error (backend not running)
      if (e.toString().contains('SocketException') ||
          e.toString().contains('Connection refused') ||
          e.toString().contains('Failed host lookup')) {
        throw Exception(
          "‚ùå Cannot connect to server. Please ensure your backend server is running on http://localhost:8080",
        );
      }
      // Re-throw other errors
      throw Exception("OTP verification failed: $e");
    }
  }

  /// Forgot Password (send OTP to email)
  static Future<Map<String, dynamic>> forgotPassword(String email) async {
    try {
      final url = Uri.parse("$baseUrl/forgot-password");
      final response = await http.post(
        url,
        headers: {"Content-Type": "application/json"},
        body: jsonEncode({"email": email}),
      );

      final body = jsonDecode(response.body);

      if (response.statusCode == 200 && body["status"] == true) {
        // Convert backend response to frontend expected format
        return {
          "success": true,
          "message": body["message"],
          "otp": body["data"]["otp"], // For development - OTP from backend
        };
      } else {
        throw Exception(body["message"] ?? "Forgot password failed");
      }
    } catch (e) {
      // Mock forgot password for development when backend is unavailable
      await Future.delayed(const Duration(seconds: 1));
      return {
        "success": true,
        "message": "OTP sent to your email address",
        "otp": "123456", // Mock OTP for development
      };
    }
  }

  /// Reset Password
  static Future<Map<String, dynamic>> resetPassword(
    String email,
    String newPassword,
    String otp,
  ) async {
    try {
      final url = Uri.parse("$baseUrl/reset-password");
      final response = await http.post(
        url,
        headers: {"Content-Type": "application/json"},
        body: jsonEncode({
          "email": email,
          "newPassword": newPassword,
          "otp": otp,
        }),
      );

      final body = jsonDecode(response.body);

      if (response.statusCode == 200 && body["status"] == true) {
        // Convert backend response to frontend expected format
        return {"success": true, "message": body["message"]};
      } else {
        throw Exception(body["message"] ?? "Reset password failed");
      }
    } catch (e) {
      // Mock response for development when backend is unavailable
      await Future.delayed(Duration(seconds: 1));

      // Validate OTP (accept any 6-digit code or "123456" for testing)
      if (otp.length == 6 &&
          (RegExp(r'^\d{6}$').hasMatch(otp) || otp == "123456")) {
        return {
          "success": true,
          "message":
              "Password reset successfully! You can now login with your new password.",
        };
      } else {
        throw Exception("Invalid OTP. Please check and try again.");
      }
    }
  }

  // ===== ADMIN PROFILE API METHODS =====

  /// Create Admin Profile
  static Future<Map<String, dynamic>> createAdminProfile({
    required String userId,
    required String firstName,
    required String lastName,
    required String email,
    required String apartment,
    required String phone,
    required String address,
    String? imagePath,
  }) async {
    try {
      print("üöÄ Creating admin profile...");
      print("üë§ User ID: $userId");
      print("üìß Email: $email");
      print("üåê Platform: ${Platform.operatingSystem}");
      print("üîó Admin Profile Base URL: $adminProfileBaseUrl");

      final url = Uri.parse(adminProfileBaseUrl);
      final response = await http.post(
        url,
        headers: {"Content-Type": "application/json"},
        body: jsonEncode({
          "userId": userId,
          "firstName": firstName,
          "lastName": lastName,
          "email": email,
          "apartment": apartment,
          "phone": phone,
          "address": address,
          "imagePath": imagePath,
        }),
      );

      print("üì± Create Profile Response Status: ${response.statusCode}");
      print("üì± Create Profile Response Body: ${response.body}");

      final body = jsonDecode(response.body);

      if (response.statusCode == 201 && body["status"] == true) {
        print("‚úÖ Admin profile created successfully!");
        return {
          "success": true,
          "message": body["message"],
          "data": body["data"],
        };
      } else {
        print("‚ùå Create profile failed: ${body["message"]}");
        throw Exception(body["message"] ?? "Failed to create admin profile");
      }
    } catch (e) {
      print("üî• Error creating admin profile: $e");
      if (e.toString().contains('SocketException') ||
          e.toString().contains('Connection refused') ||
          e.toString().contains('Failed host lookup')) {
        throw Exception(
          "‚ùå Cannot connect to server. Please ensure your backend server is running on http://localhost:8080",
        );
      }
      throw Exception("Failed to create admin profile: $e");
    }
  }

  /// Get Admin Profile by User ID (get current user's profile)
  static Future<Map<String, dynamic>> getAdminProfileByUserId(
    String userId,
  ) async {
    try {
      print("üîç Fetching admin profile for user: $userId");
      print("üîó Admin Profile Base URL: $adminProfileBaseUrl");

      // Use the correct endpoint from your backend: /api/admin-profiles/user/:userId
      final url = Uri.parse("$adminProfileBaseUrl/user/$userId");
      final response = await http.get(
        url,
        headers: {"Content-Type": "application/json"},
      );

      print("üì± Get Profile Response Status: ${response.statusCode}");
      print("üì± Get Profile Response Body: ${response.body}");

      final body = jsonDecode(response.body);

      if (response.statusCode == 200 && body["status"] == true) {
        print("‚úÖ Admin profile fetched successfully!");
        print("üîç Profile data: ${body["data"]}");
        return {"success": true, "data": body["data"]};
      } else {
        print("‚ùå Get profile failed: ${body["message"]}");
        print("üîç Full response body: $body");
        return {
          "success": false,
          "message": body["message"] ?? "Failed to fetch admin profile",
        };
      }
    } catch (e) {
      print("üî• Error fetching admin profile: $e");
      if (e.toString().contains('SocketException') ||
          e.toString().contains('Connection refused') ||
          e.toString().contains('Failed host lookup')) {
        throw Exception(
          "‚ùå Cannot connect to server. Please ensure your backend server is running on http://localhost:8080",
        );
      }
      throw Exception("Failed to fetch admin profile: $e");
    }
  }

  /// Get All Admin Profiles
  static Future<Map<String, dynamic>> getAllAdminProfiles() async {
    try {
      print("üîç Fetching all admin profiles...");
      print("üîó Admin Profile Base URL: $adminProfileBaseUrl");

      final url = Uri.parse(adminProfileBaseUrl);
      final response = await http.get(
        url,
        headers: {"Content-Type": "application/json"},
      );

      print("üì± Get All Profiles Response Status: ${response.statusCode}");
      print("üì± Get All Profiles Response Body: ${response.body}");

      final body = jsonDecode(response.body);

      if (response.statusCode == 200 && body["status"] == true) {
        print("‚úÖ All admin profiles fetched successfully!");
        return {"success": true, "data": body["data"]};
      } else {
        print("‚ùå Get all profiles failed: ${body["message"]}");
        throw Exception(body["message"] ?? "Failed to fetch admin profiles");
      }
    } catch (e) {
      print("üî• Error fetching all admin profiles: $e");
      if (e.toString().contains('SocketException') ||
          e.toString().contains('Connection refused') ||
          e.toString().contains('Failed host lookup')) {
        throw Exception(
          "‚ùå Cannot connect to server. Please ensure your backend server is running on http://localhost:8080",
        );
      }
      throw Exception("Failed to fetch admin profiles: $e");
    }
  }

  /// Update Admin Profile
  static Future<Map<String, dynamic>> updateAdminProfile({
    required String profileId,
    required String firstName,
    required String lastName,
    required String email,
    required String apartment,
    required String phone,
    required String address,
    String? imagePath,
  }) async {
    try {
      print("üîÑ Updating admin profile: $profileId");
      print("üîó Admin Profile Base URL: $adminProfileBaseUrl");

      final url = Uri.parse("$adminProfileBaseUrl/$profileId");
      final response = await http.put(
        url,
        headers: {"Content-Type": "application/json"},
        body: jsonEncode({
          "firstName": firstName,
          "lastName": lastName,
          "email": email,
          "apartment": apartment,
          "phone": phone,
          "address": address,
          "imagePath": imagePath,
        }),
      );

      print("üì± Update Profile Response Status: ${response.statusCode}");
      print("üì± Update Profile Response Body: ${response.body}");

      final body = jsonDecode(response.body);

      if (response.statusCode == 200 && body["status"] == true) {
        print("‚úÖ Admin profile updated successfully!");
        return {
          "success": true,
          "message": body["message"],
          "data": body["data"],
        };
      } else {
        print("‚ùå Update profile failed: ${body["message"]}");
        throw Exception(body["message"] ?? "Failed to update admin profile");
      }
    } catch (e) {
      print("üî• Error updating admin profile: $e");
      if (e.toString().contains('SocketException') ||
          e.toString().contains('Connection refused') ||
          e.toString().contains('Failed host lookup')) {
        throw Exception(
          "‚ùå Cannot connect to server. Please ensure your backend server is running on http://localhost:8080",
        );
      }
      throw Exception("Failed to update admin profile: $e");
    }
  }

  /// Update user's isProfile status in signup collection
  static Future<Map<String, dynamic>> updateProfileStatus({
    required String userId,
    required bool isProfile,
  }) async {
    try {
      print("üîÑ Updating profile status for user: $userId to $isProfile");

      final url = Uri.parse("$baseUrl/update-profile-status");
      final response = await http.put(
        url,
        headers: {"Content-Type": "application/json"},
        body: jsonEncode({"userId": userId, "isProfile": isProfile}),
      );

      print("üì± Update Profile Status Response Status: ${response.statusCode}");
      print("üì± Update Profile Status Response Body: ${response.body}");

      final body = jsonDecode(response.body);

      if (response.statusCode == 200 && body["status"] == true) {
        print("‚úÖ Profile status updated successfully!");
        return {"success": true, "message": body["message"]};
      } else {
        print("‚ùå Update profile status failed: ${body["message"]}");
        throw Exception(body["message"] ?? "Failed to update profile status");
      }
    } catch (e) {
      print("üî• Error updating profile status: $e");
      if (e.toString().contains('SocketException') ||
          e.toString().contains('Connection refused') ||
          e.toString().contains('Failed host lookup')) {
        throw Exception(
          "‚ùå Cannot connect to server. Please ensure your backend server is running on http://localhost:8080",
        );
      }
      throw Exception("Failed to update profile status: $e");
    }
  }

  // ===== ADMIN MEMBER MANAGEMENT APIs =====

  /// Admin Creates Member
  static Future<Map<String, dynamic>> adminCreateMember({
    required String adminId,
    required String userId,
    required String password,
    String? profileImage,
    required String firstName,
    required String lastName,
    required String mobile,
    required String email,
    required String floor,
    required String flatNo,
    String? paymentStatus,
    String? parkingArea,
    String? parkingSlot,
    required String govtIdType,
    required String govtIdImage,
  }) async {
    try {
      print("üöÄ Starting admin create member process...");
      print("üîë Admin ID: $adminId");
      print("üÜî User ID: $userId");
      print("üë§ Member: $firstName $lastName");
      print("üìß Email: $email");
      print("üì± Mobile: $mobile");
      print("üè¢ Flat: Floor $floor, Flat $flatNo");
      print(
        "üÖøÔ∏è Parking: ${parkingArea ?? 'Not Assigned'}-${parkingSlot ?? 'Not Assigned'}",
      );
      print("üåê Base URL: $adminMemberBaseUrl");

      final url = Uri.parse("$adminMemberBaseUrl/create");
      final response = await http.post(
        url,
        headers: {"Content-Type": "application/json"},
        body: jsonEncode({
          "adminId": adminId,
          "userId": userId,
          "password": password,
          "profileImage": profileImage,
          "firstName": firstName,
          "lastName": lastName,
          "mobile": mobile,
          "email": email,
          "floor": floor,
          "flatNo": flatNo,
          "paymentStatus": paymentStatus ?? "Available",
          "parkingArea": parkingArea ?? "Not Assigned",
          "parkingSlot": parkingSlot ?? "Not Assigned",
          "govtIdType": govtIdType,
          "govtIdImage": govtIdImage,
        }),
      );

      print("üì± Create Member Response Status: ${response.statusCode}");
      print("üì± Create Member Response Body: ${response.body}");

      final body = jsonDecode(response.body);

      if (response.statusCode == 201 && body["success"] == true) {
        print("‚úÖ Member created successfully!");
        return {
          "success": true,
          "message": body["message"],
          "data": body["data"],
        };
      } else {
        print("‚ùå Create member failed: ${body["message"]}");
        throw Exception(body["message"] ?? "Failed to create member");
      }
    } catch (e) {
      print("üî• Error creating member: $e");
      if (e.toString().contains('SocketException') ||
          e.toString().contains('Connection refused') ||
          e.toString().contains('Failed host lookup')) {
        throw Exception(
          "‚ùå Cannot connect to server. Please ensure your backend server is running on http://localhost:8080",
        );
      }
      throw Exception("Failed to create member: $e");
    }
  }

  /// Get Members Created by Admin
  static Future<Map<String, dynamic>> getAdminMembers(String adminId) async {
    try {
      print("üîç Fetching members for admin: $adminId");
      print("üåê Base URL: $adminMemberBaseUrl");

      final url = Uri.parse("$adminMemberBaseUrl/admin/$adminId");
      final response = await http.get(
        url,
        headers: {"Content-Type": "application/json"},
      );

      print("üì± Get Members Response Status: ${response.statusCode}");
      print("üì± Get Members Response Body: ${response.body}");

      final body = jsonDecode(response.body);

      if (response.statusCode == 200 && body["success"] == true) {
        print("‚úÖ Members fetched successfully! Count: ${body["count"]}");
        return {"success": true, "count": body["count"], "data": body["data"]};
      } else {
        print("‚ùå Fetch members failed: ${body["message"]}");
        throw Exception(body["message"] ?? "Failed to fetch members");
      }
    } catch (e) {
      print("üî• Error fetching members: $e");
      if (e.toString().contains('SocketException') ||
          e.toString().contains('Connection refused') ||
          e.toString().contains('Failed host lookup')) {
        throw Exception(
          "‚ùå Cannot connect to server. Please ensure your backend server is running on http://localhost:8080",
        );
      }
      throw Exception("Failed to fetch members: $e");
    }
  }

  /// Member Login with Admin-Created Credentials
  static Future<Map<String, dynamic>> memberLogin({
    required String userId,
    required String password,
  }) async {
    try {
      print("üîê Starting member login process...");
      print("üë§ User ID: $userId");
      print("üåê Base URL: $adminMemberBaseUrl");

      final url = Uri.parse("$adminMemberBaseUrl/member-login");
      final response = await http.post(
        url,
        headers: {"Content-Type": "application/json"},
        body: jsonEncode({"userId": userId, "password": password}),
      );

      print("üì± Member Login Response Status: ${response.statusCode}");
      print("üì± Member Login Response Body: ${response.body}");

      final body = jsonDecode(response.body);

      if (response.statusCode == 200 && body["success"] == true) {
        print("‚úÖ Member login successful!");
        return {
          "success": true,
          "message": body["message"],
          "data": body["data"],
        };
      } else {
        print("‚ùå Member login failed: ${body["message"]}");
        throw Exception(body["message"] ?? "Failed to login");
      }
    } catch (e) {
      print("üî• Error during member login: $e");
      if (e.toString().contains('SocketException') ||
          e.toString().contains('Connection refused') ||
          e.toString().contains('Failed host lookup')) {
        throw Exception(
          "‚ùå Cannot connect to server. Please ensure your backend server is running on http://localhost:8080",
        );
      }
      throw Exception("Failed to login: $e");
    }
  }

  /// Admin Updates Member
  static Future<Map<String, dynamic>> adminUpdateMember({
    required String adminId,
    required String memberId,
    required Map<String, dynamic> updateData,
  }) async {
    try {
      print("‚úèÔ∏è Starting admin update member process...");
      print("üîë Admin ID: $adminId");
      print("üë§ Member ID: $memberId");
      print("üìù Update Data: $updateData");
      print("üåê Base URL: $adminMemberBaseUrl");

      final url = Uri.parse(
        "$adminMemberBaseUrl/admin/$adminId/member/$memberId",
      );
      final response = await http.put(
        url,
        headers: {"Content-Type": "application/json"},
        body: jsonEncode(updateData),
      );

      print("üì± Update Member Response Status: ${response.statusCode}");
      print("üì± Update Member Response Body: ${response.body}");

      final body = jsonDecode(response.body);

      if (response.statusCode == 200 && body["success"] == true) {
        print("‚úÖ Member updated successfully!");
        return {
          "success": true,
          "message": body["message"],
          "data": body["data"],
        };
      } else {
        print("‚ùå Update member failed: ${body["message"]}");
        throw Exception(body["message"] ?? "Failed to update member");
      }
    } catch (e) {
      print("üî• Error updating member: $e");
      if (e.toString().contains('SocketException') ||
          e.toString().contains('Connection refused') ||
          e.toString().contains('Failed host lookup')) {
        throw Exception(
          "‚ùå Cannot connect to server. Please ensure your backend server is running on http://localhost:8080",
        );
      }
      throw Exception("Failed to update member: $e");
    }
  }

  /// Admin Deletes Member
  static Future<Map<String, dynamic>> adminDeleteMember({
    required String adminId,
    required String memberId,
  }) async {
    try {
      print("üóëÔ∏è Starting admin delete member process...");
      print("üîë Admin ID: $adminId");
      print("üë§ Member ID: $memberId");
      print("üåê Base URL: $adminMemberBaseUrl");

      final url = Uri.parse(
        "$adminMemberBaseUrl/admin/$adminId/member/$memberId",
      );
      final response = await http.delete(
        url,
        headers: {"Content-Type": "application/json"},
      );

      print("üì± Delete Member Response Status: ${response.statusCode}");
      print("üì± Delete Member Response Body: ${response.body}");

      final body = jsonDecode(response.body);

      if (response.statusCode == 200 && body["success"] == true) {
        print("‚úÖ Member deleted successfully!");
        return {"success": true, "message": body["message"]};
      } else {
        print("‚ùå Delete member failed: ${body["message"]}");
        throw Exception(body["message"] ?? "Failed to delete member");
      }
    } catch (e) {
      print("üî• Error deleting member: $e");
      if (e.toString().contains('SocketException') ||
          e.toString().contains('Connection refused') ||
          e.toString().contains('Failed host lookup')) {
        throw Exception(
          "‚ùå Cannot connect to server. Please ensure your backend server is running on http://localhost:8080",
        );
      }
      throw Exception("Failed to delete member: $e");
    }
  }

  // ========================= AMENITIES API METHODS =========================

  /// Create Amenity
  static Future<Map<String, dynamic>> createAmenity({
    required String createdByAdminId,
    required String name,
    required String description,
    required int capacity,
    required List<String> imagePaths,
    String? location,
    double? hourlyRate,
    List<String>? features,
    bool? active,
  }) async {
    try {
      print("üöÄ Starting create amenity process...");
      print("üîë Admin ID: $createdByAdminId");
      print("üèä Amenity: $name");
      print("ÔøΩ Capacity: $capacity");
      print("üí∞ Hourly Rate: ${hourlyRate ?? 0.0}");
      print("üì∏ Images: ${imagePaths.length} images");
      print("üåê Base URL: $amenitiesBaseUrl");

      final url = Uri.parse("$amenitiesBaseUrl/admin/$createdByAdminId");
      final response = await http.post(
        url,
        headers: {"Content-Type": "application/json"},
        body: jsonEncode({
          "name": name,
          "description": description,
          "capacity": capacity,
          "imagePaths": imagePaths,
          "location": location ?? "",
          "hourlyRate": hourlyRate ?? 0.0,
          "features": features ?? [],
          "active": active ?? true,
        }),
      );

      print("üì± Create Amenity Response Status: ${response.statusCode}");
      print("üì± Create Amenity Response Body: ${response.body}");

      // Check if response is HTML (404 error page) instead of JSON
      if (response.statusCode == 404) {
        print("‚ùå Create amenity API endpoint not found (404)");
        print(
          "üí° Backend routes are not registered. Please integrate amenities routes.",
        );
        throw Exception(
          "Amenities API not available. Please integrate the amenities routes in your backend server. See QUICK_FIX_SUMMARY.md for instructions.",
        );
      }

      // Try to parse JSON, handle non-JSON responses gracefully
      late Map<String, dynamic> body;
      try {
        body = jsonDecode(response.body);
      } catch (e) {
        print("‚ùå Invalid JSON response from server");
        print("üî• Response was: ${response.body.substring(0, 200)}...");
        throw Exception(
          "Server returned invalid response. Expected JSON but got HTML. Please check if amenities routes are properly registered in your backend.",
        );
      }

      if (response.statusCode == 201 && body["success"] == true) {
        print("‚úÖ Amenity created successfully!");
        return {
          "success": true,
          "message": body["message"],
          "data": body["data"],
        };
      } else {
        print("‚ùå Create amenity failed: ${body["message"]}");
        throw Exception(body["message"] ?? "Failed to create amenity");
      }
    } catch (e) {
      print("üî• Error creating amenity: $e");
      if (e.toString().contains('SocketException') ||
          e.toString().contains('Connection refused') ||
          e.toString().contains('Failed host lookup')) {
        throw Exception(
          "‚ùå Cannot connect to server. Please ensure your backend server is running on http://localhost:8080",
        );
      }
      throw Exception("Failed to create amenity: $e");
    }
  }

  /// Get All Amenities for Admin
  static Future<Map<String, dynamic>> getAllAmenities({
    required String adminId,
    Map<String, dynamic>? filters,
  }) async {
    try {
      print("üöÄ Fetching all amenities...");
      print("üîë Admin ID: $adminId");
      print("üîç Filters: ${filters ?? 'None'}");
      print("üåê Base URL: $amenitiesBaseUrl");

      // Build query parameters
      String queryString = "";
      if (filters != null && filters.isNotEmpty) {
        final queryParams = <String>[];
        filters.forEach((key, value) {
          if (value != null) {
            queryParams.add("$key=${Uri.encodeComponent(value.toString())}");
          }
        });
        if (queryParams.isNotEmpty) {
          queryString = "?${queryParams.join('&')}";
        }
      }

      final url = Uri.parse("$amenitiesBaseUrl/admin/$adminId$queryString");
      final response = await http.get(
        url,
        headers: {"Content-Type": "application/json"},
      );

      print("üì± Get All Amenities Response Status: ${response.statusCode}");
      print("üì± Get All Amenities Response Body: ${response.body}");

      // Check if response is HTML (404 error page) instead of JSON
      if (response.statusCode == 404) {
        print("‚ùå Amenities API endpoint not found (404)");
        print(
          "üí° Backend routes are not registered. Please integrate amenities routes.",
        );
        throw Exception(
          "Amenities API not available. Please integrate the amenities routes in your backend server. See QUICK_FIX_SUMMARY.md for instructions.",
        );
      }

      // Try to parse JSON, handle non-JSON responses gracefully
      late Map<String, dynamic> body;
      try {
        body = jsonDecode(response.body);
      } catch (e) {
        print("‚ùå Invalid JSON response from server");
        print("üî• Response was: ${response.body.substring(0, 200)}...");
        throw Exception(
          "Server returned invalid response. Expected JSON but got HTML. Please check if amenities routes are properly registered in your backend.",
        );
      }

      if (response.statusCode == 200 && body["success"] == true) {
        print("‚úÖ Amenities fetched successfully!");
        return {
          "success": true,
          "message": body["message"],
          "data": body["data"]["amenities"] ?? [],
          "totalAmenities": body["data"]["totalAmenities"] ?? 0,
        };
      } else {
        print("‚ùå Get amenities failed: ${body["message"]}");
        throw Exception(body["message"] ?? "Failed to fetch amenities");
      }
    } catch (e) {
      print("üî• Error fetching amenities: $e");
      if (e.toString().contains('SocketException') ||
          e.toString().contains('Connection refused') ||
          e.toString().contains('Failed host lookup')) {
        throw Exception(
          "‚ùå Cannot connect to server. Please ensure your backend server is running on http://localhost:8080",
        );
      }
      throw Exception("Failed to fetch amenities: $e");
    }
  }

  /// Get Amenity by ID
  static Future<Map<String, dynamic>> getAmenityById({
    required String adminId,
    required String amenityId,
  }) async {
    try {
      print("üöÄ Fetching amenity by ID: $amenityId");
      print("üîë Admin ID: $adminId");
      print("üåê Base URL: $amenitiesBaseUrl");

      final url = Uri.parse(
        "$amenitiesBaseUrl/admin/$adminId/amenity/$amenityId",
      );
      final response = await http.get(
        url,
        headers: {"Content-Type": "application/json"},
      );

      print("üì± Get Amenity Response Status: ${response.statusCode}");
      print("üì± Get Amenity Response Body: ${response.body}");

      final body = jsonDecode(response.body);

      if (response.statusCode == 200 && body["success"] == true) {
        print("‚úÖ Amenity fetched successfully!");
        return {
          "success": true,
          "message": body["message"],
          "data": body["data"]["amenity"],
        };
      } else {
        print("‚ùå Get amenity failed: ${body["message"]}");
        throw Exception(body["message"] ?? "Failed to fetch amenity");
      }
    } catch (e) {
      print("üî• Error fetching amenity: $e");
      if (e.toString().contains('SocketException') ||
          e.toString().contains('Connection refused') ||
          e.toString().contains('Failed host lookup')) {
        throw Exception(
          "‚ùå Cannot connect to server. Please ensure your backend server is running on http://localhost:8080",
        );
      }
      throw Exception("Failed to fetch amenity: $e");
    }
  }

  /// Update Amenity
  static Future<Map<String, dynamic>> updateAmenity({
    required String adminId,
    required String amenityId,
    String? name,
    String? description,
    int? capacity,
    List<String>? imagePaths,
    String? location,
    double? hourlyRate,
    List<String>? features,
    bool? active,
  }) async {
    try {
      print("üöÄ Starting update amenity process...");
      print("üîë Admin ID: $adminId");
      print("üÜî Amenity ID: $amenityId");
      print("üèä Updated Name: ${name ?? 'No change'}");
      print("üí∞ Updated Hourly Rate: ${hourlyRate ?? 'No change'}");
      print("üåê Base URL: $amenitiesBaseUrl");

      // Create update data map, only include non-null values
      Map<String, dynamic> updateData = {};
      if (name != null) updateData['name'] = name;
      if (description != null) updateData['description'] = description;
      if (capacity != null) updateData['capacity'] = capacity;
      if (imagePaths != null) updateData['imagePaths'] = imagePaths;
      if (location != null) updateData['location'] = location;
      if (hourlyRate != null) updateData['hourlyRate'] = hourlyRate;
      if (features != null) updateData['features'] = features;
      if (active != null) updateData['active'] = active;

      final url = Uri.parse(
        "$amenitiesBaseUrl/admin/$adminId/amenity/$amenityId",
      );
      final response = await http.put(
        url,
        headers: {"Content-Type": "application/json"},
        body: jsonEncode(updateData),
      );

      print("üì± Update Amenity Response Status: ${response.statusCode}");
      print("üì± Update Amenity Response Body: ${response.body}");

      final body = jsonDecode(response.body);

      if (response.statusCode == 200 && body["success"] == true) {
        print("‚úÖ Amenity updated successfully!");
        return {
          "success": true,
          "message": body["message"],
          "data": body["data"]["amenity"],
        };
      } else {
        print("‚ùå Update amenity failed: ${body["message"]}");
        throw Exception(body["message"] ?? "Failed to update amenity");
      }
    } catch (e) {
      print("üî• Error updating amenity: $e");
      if (e.toString().contains('SocketException') ||
          e.toString().contains('Connection refused') ||
          e.toString().contains('Failed host lookup')) {
        throw Exception(
          "‚ùå Cannot connect to server. Please ensure your backend server is running on http://localhost:8080",
        );
      }
      throw Exception("Failed to update amenity: $e");
    }
  }

  /// Delete Amenity (Soft Delete by default)
  static Future<Map<String, dynamic>> deleteAmenity({
    required String adminId,
    required String amenityId,
    bool hardDelete = false,
  }) async {
    try {
      print("üöÄ Starting delete amenity process...");
      print("üîë Admin ID: $adminId");
      print("üÜî Amenity ID: $amenityId");
      print("üí• Hard Delete: $hardDelete");
      print("üåê Base URL: $amenitiesBaseUrl");

      String queryString = hardDelete ? "?hardDelete=true" : "";
      final url = Uri.parse(
        "$amenitiesBaseUrl/admin/$adminId/amenity/$amenityId$queryString",
      );
      final response = await http.delete(
        url,
        headers: {"Content-Type": "application/json"},
      );

      print("üì± Delete Amenity Response Status: ${response.statusCode}");
      print("üì± Delete Amenity Response Body: ${response.body}");

      final body = jsonDecode(response.body);

      if (response.statusCode == 200 && body["success"] == true) {
        print("‚úÖ Amenity deleted successfully!");
        return {
          "success": true,
          "message": body["message"],
          "data": body["data"],
        };
      } else {
        print("‚ùå Delete amenity failed: ${body["message"]}");
        throw Exception(body["message"] ?? "Failed to delete amenity");
      }
    } catch (e) {
      print("üî• Error deleting amenity: $e");
      if (e.toString().contains('SocketException') ||
          e.toString().contains('Connection refused') ||
          e.toString().contains('Failed host lookup')) {
        throw Exception(
          "‚ùå Cannot connect to server. Please ensure your backend server is running on http://localhost:8080",
        );
      }
      throw Exception("Failed to delete amenity: $e");
    }
  }

  /// Toggle Amenity Status (Active/Inactive)
  static Future<Map<String, dynamic>> toggleAmenityStatus({
    required String adminId,
    required String amenityId,
  }) async {
    try {
      print("üöÄ Starting toggle amenity status process...");
      print("üîë Admin ID: $adminId");
      print("üÜî Amenity ID: $amenityId");
      print("üåê Base URL: $amenitiesBaseUrl");

      final url = Uri.parse(
        "$amenitiesBaseUrl/admin/$adminId/amenity/$amenityId/toggle-status",
      );
      final response = await http.patch(
        url,
        headers: {"Content-Type": "application/json"},
      );

      print("üì± Toggle Status Response Status: ${response.statusCode}");
      print("üì± Toggle Status Response Body: ${response.body}");

      final body = jsonDecode(response.body);

      if (response.statusCode == 200 && body["success"] == true) {
        print("‚úÖ Amenity status toggled successfully!");
        return {
          "success": true,
          "message": body["message"],
          "data": body["data"]["amenity"],
        };
      } else {
        print("‚ùå Toggle status failed: ${body["message"]}");
        throw Exception(body["message"] ?? "Failed to toggle amenity status");
      }
    } catch (e) {
      print("üî• Error toggling amenity status: $e");
      if (e.toString().contains('SocketException') ||
          e.toString().contains('Connection refused') ||
          e.toString().contains('Failed host lookup')) {
        throw Exception(
          "‚ùå Cannot connect to server. Please ensure your backend server is running on http://localhost:8080",
        );
      }
      throw Exception("Failed to toggle amenity status: $e");
    }
  }

  // ==================== EVENT CARD API METHODS ====================

  /// Create Event Card
  static Future<Map<String, dynamic>> createEventCard({
    String? image,
    required String name,
    required String startdate,
    required String enddate,
    required String description,
    required double targetamount,
    List<String>? eventdetails,
    required String adminId,
  }) async {
    try {
      print("üöÄ Creating event card...");
      print("üìÖ Event: $name");
      print("üñºÔ∏è Image data length: ${image?.length ?? 0} characters");
      print("üåê URL: $eventsBaseUrl");

      final url = Uri.parse(eventsBaseUrl);

      // Convert single image to array format that backend expects
      List<String>? images;
      if (image != null && image.isNotEmpty) {
        images = [image];
        print("‚úÖ Converted single image to array format");
      }

      final response = await http.post(
        url,
        headers: {"Content-Type": "application/json"},
        body: jsonEncode({
          "images": images, // Changed from "image" to "images" to match backend
          "name": name,
          "startdate": startdate,
          "enddate": enddate,
          "description": description,
          "targetamount": targetamount,
          "eventdetails": eventdetails ?? [],
          "adminId": adminId,
        }),
      );

      print("üì± Create Event Response Status: ${response.statusCode}");
      print("üì± Create Event Response Body: ${response.body}");

      // Check if response is HTML (error page) instead of JSON
      if (response.statusCode == 404) {
        print("‚ùå Create event API endpoint not found (404)");
        throw Exception(
          "Events API endpoint not found. Please check your backend server routes.",
        );
      }

      if (response.statusCode >= 500) {
        print("‚ùå Server error (${response.statusCode})");
        if (response.body.contains('<!DOCTYPE html>') ||
            response.body.contains('<html>')) {
          throw Exception(
            "Server error occurred while processing the image. Please check your backend server logs.",
          );
        }
      }

      // Try to parse JSON, handle non-JSON responses gracefully
      late Map<String, dynamic> body;
      try {
        body = jsonDecode(response.body);
      } catch (e) {
        print("‚ùå Invalid JSON response from server");
        final maxLength = response.body.length > 200
            ? 200
            : response.body.length;
        print("üî• Response was: ${response.body.substring(0, maxLength)}...");
        if (response.body.contains('<!DOCTYPE html>') ||
            response.body.contains('<html>')) {
          throw Exception(
            "Server returned HTML error page instead of JSON. This usually means there's an error processing the image data on the backend.",
          );
        }
        final previewLength = response.body.length > 100
            ? 100
            : response.body.length;
        throw Exception(
          "Server returned invalid response. Expected JSON but got: ${response.body.substring(0, previewLength)}",
        );
      }

      if (response.statusCode == 201 && body["success"] == true) {
        print("‚úÖ Event card created successfully!");
        return {
          "success": true,
          "message": body["message"],
          "data": body["data"],
        };
      } else {
        print("‚ùå Create event failed: ${body["message"]}");
        throw Exception(body["message"] ?? "Failed to create event card");
      }
    } catch (e) {
      print("üî• Error creating event card: $e");
      if (e.toString().contains('SocketException') ||
          e.toString().contains('Connection refused') ||
          e.toString().contains('Failed host lookup')) {
        throw Exception(
          "‚ùå Cannot connect to server. Please ensure your backend server is running on http://localhost:8080",
        );
      }
      throw Exception("Failed to create event card: $e");
    }
  }

  /// Get All Event Cards
  static Future<Map<String, dynamic>> getAllEventCards() async {
    try {
      print("üöÄ Fetching all event cards...");
      print("üåê URL: $eventsBaseUrl");

      final url = Uri.parse(eventsBaseUrl);
      final response = await http.get(
        url,
        headers: {"Content-Type": "application/json"},
      );

      print("üì± Get All Events Response Status: ${response.statusCode}");
      print("üì± Get All Events Response Body: ${response.body}");

      final body = jsonDecode(response.body);

      if (response.statusCode == 200 && body["success"] == true) {
        print("‚úÖ Event cards fetched successfully!");
        return {
          "success": true,
          "message": "Event cards fetched successfully",
          "data": body["data"],
        };
      } else {
        print("‚ùå Fetch events failed: ${body["message"]}");
        throw Exception(body["message"] ?? "Failed to fetch event cards");
      }
    } catch (e) {
      print("üî• Error fetching event cards: $e");
      if (e.toString().contains('SocketException') ||
          e.toString().contains('Connection refused') ||
          e.toString().contains('Failed host lookup')) {
        throw Exception(
          "‚ùå Cannot connect to server. Please ensure your backend server is running on http://localhost:8080",
        );
      }
      throw Exception("Failed to fetch event cards: $e");
    }
  }

  /// Get Event Card by ID
  static Future<Map<String, dynamic>> getEventCardById(String id) async {
    try {
      print("üöÄ Fetching event card by ID...");
      print("üÜî Event ID: $id");
      print("üåê URL: $eventsBaseUrl/$id");

      final url = Uri.parse("$eventsBaseUrl/$id");
      final response = await http.get(
        url,
        headers: {"Content-Type": "application/json"},
      );

      print("üì± Get Event Response Status: ${response.statusCode}");
      print("üì± Get Event Response Body: ${response.body}");

      final body = jsonDecode(response.body);

      if (response.statusCode == 200 && body["success"] == true) {
        print("‚úÖ Event card fetched successfully!");
        return {
          "success": true,
          "message": "Event card fetched successfully",
          "data": body["data"],
        };
      } else {
        print("‚ùå Fetch event failed: ${body["message"]}");
        throw Exception(body["message"] ?? "Failed to fetch event card");
      }
    } catch (e) {
      print("üî• Error fetching event card: $e");
      if (e.toString().contains('SocketException') ||
          e.toString().contains('Connection refused') ||
          e.toString().contains('Failed host lookup')) {
        throw Exception(
          "‚ùå Cannot connect to server. Please ensure your backend server is running on http://localhost:8080",
        );
      }
      throw Exception("Failed to fetch event card: $e");
    }
  }

  /// Update Event Card
  static Future<Map<String, dynamic>> updateEventCard({
    required String id,
    required String adminId,
    String? image,
    String? name,
    String? startdate,
    String? enddate,
    String? description,
    double? targetamount,
    List<String>? eventdetails,
    bool? status,
  }) async {
    try {
      print("üöÄ Updating event card...");
      print("üÜî Event ID: $id");
      print("üë§ Admin ID: $adminId");
      print("üåê URL: $eventsBaseUrl/$id");

      final Map<String, dynamic> updateData = {"adminId": adminId};

      if (image != null) updateData["image"] = image;
      if (name != null) updateData["name"] = name;
      if (startdate != null) updateData["startdate"] = startdate;
      if (enddate != null) updateData["enddate"] = enddate;
      if (description != null) updateData["description"] = description;
      if (targetamount != null) updateData["targetamount"] = targetamount;
      if (eventdetails != null) updateData["eventdetails"] = eventdetails;
      if (status != null) updateData["status"] = status;

      final url = Uri.parse("$eventsBaseUrl/$id");
      final response = await http.put(
        url,
        headers: {"Content-Type": "application/json"},
        body: jsonEncode(updateData),
      );

      print("üì± Update Event Response Status: ${response.statusCode}");
      print("üì± Update Event Response Body: ${response.body}");

      final body = jsonDecode(response.body);

      if (response.statusCode == 200 && body["success"] == true) {
        print("‚úÖ Event card updated successfully!");
        return {
          "success": true,
          "message": body["message"],
          "data": body["data"],
        };
      } else {
        print("‚ùå Update event failed: ${body["message"]}");
        throw Exception(body["message"] ?? "Failed to update event card");
      }
    } catch (e) {
      print("üî• Error updating event card: $e");
      if (e.toString().contains('SocketException') ||
          e.toString().contains('Connection refused') ||
          e.toString().contains('Failed host lookup')) {
        throw Exception(
          "‚ùå Cannot connect to server. Please ensure your backend server is running on http://localhost:8080",
        );
      }
      throw Exception("Failed to update event card: $e");
    }
  }

  /// Delete Event Card
  static Future<Map<String, dynamic>> deleteEventCard(String id) async {
    try {
      print("üöÄ Deleting event card...");
      print("üÜî Event ID: $id");
      print("üåê URL: $eventsBaseUrl/$id");

      final url = Uri.parse("$eventsBaseUrl/$id");
      final response = await http.delete(
        url,
        headers: {"Content-Type": "application/json"},
      );

      print("üì± Delete Event Response Status: ${response.statusCode}");
      print("üì± Delete Event Response Body: ${response.body}");

      final body = jsonDecode(response.body);

      if (response.statusCode == 200 && body["success"] == true) {
        print("‚úÖ Event card deleted successfully!");
        return {"success": true, "message": body["message"]};
      } else {
        print("‚ùå Delete event failed: ${body["message"]}");
        throw Exception(body["message"] ?? "Failed to delete event card");
      }
    } catch (e) {
      print("üî• Error deleting event card: $e");
      if (e.toString().contains('SocketException') ||
          e.toString().contains('Connection refused') ||
          e.toString().contains('Failed host lookup')) {
        throw Exception(
          "‚ùå Cannot connect to server. Please ensure your backend server is running on http://localhost:8080",
        );
      }
      throw Exception("Failed to delete event card: $e");
    }
  }

  /// Add Event Donation
  static Future<Map<String, dynamic>> addEventDonation({
    required String eventId,
    required String userId,
    required double amount,
  }) async {
    try {
      print("üöÄ Adding event donation...");
      print("üÜî Event ID: $eventId");
      print("üë§ User ID: $userId");
      print("üí∞ Amount: $amount");
      print("üåê URL: $eventsBaseUrl/$eventId/donate");

      final url = Uri.parse("$eventsBaseUrl/$eventId/donate");
      final response = await http.post(
        url,
        headers: {"Content-Type": "application/json"},
        body: jsonEncode({"userId": userId, "amount": amount}),
      );

      print("üì± Add Donation Response Status: ${response.statusCode}");
      print("üì± Add Donation Response Body: ${response.body}");

      final body = jsonDecode(response.body);

      if (response.statusCode == 200 && body["success"] == true) {
        print("‚úÖ Donation added successfully!");
        return {
          "success": true,
          "message": body["message"],
          "data": body["data"],
        };
      } else {
        print("‚ùå Add donation failed: ${body["message"]}");
        throw Exception(body["message"] ?? "Failed to add donation");
      }
    } catch (e) {
      print("üî• Error adding donation: $e");
      if (e.toString().contains('SocketException') ||
          e.toString().contains('Connection refused') ||
          e.toString().contains('Failed host lookup')) {
        throw Exception(
          "‚ùå Cannot connect to server. Please ensure your backend server is running on http://localhost:8080",
        );
      }
      throw Exception("Failed to add donation: $e");
    }
  }

  /// Toggle Event Status
  static Future<Map<String, dynamic>> toggleEventStatus(String id) async {
    try {
      print("üöÄ Toggling event status...");
      print("üÜî Event ID: $id");
      print("üåê URL: $eventsBaseUrl/$id/toggle");

      final url = Uri.parse("$eventsBaseUrl/$id/toggle");
      final response = await http.put(
        url,
        headers: {"Content-Type": "application/json"},
      );

      print("üì± Toggle Event Status Response Status: ${response.statusCode}");
      print("üì± Toggle Event Status Response Body: ${response.body}");

      final body = jsonDecode(response.body);

      if (response.statusCode == 200 && body["success"] == true) {
        print("‚úÖ Event status toggled successfully!");
        return {
          "success": true,
          "message": body["message"],
          "status": body["status"],
        };
      } else {
        print("‚ùå Toggle event status failed: ${body["message"]}");
        throw Exception(body["message"] ?? "Failed to toggle event status");
      }
    } catch (e) {
      print("üî• Error toggling event status: $e");
      if (e.toString().contains('SocketException') ||
          e.toString().contains('Connection refused') ||
          e.toString().contains('Failed host lookup')) {
        throw Exception(
          "‚ùå Cannot connect to server. Please ensure your backend server is running on http://localhost:8080",
        );
      }
      throw Exception("Failed to toggle event status: $e");
    }
  }
}
